FROM jenkins/jenkins:jdk11

USER root
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -qq -y --no-install-recommends \
git \
python3 \
python3-pip \
ca-certificates \
wget \
vim \
less \
ca-certificates \
gnupg2

RUN export GNUPGHOME="$(mktemp -d)" \
    && wget -q -O - https://dist.sapmachine.io/debian/sapmachine.old.key | gpg --batch --import \
    && gpg --batch --export --armor 'DA4C 00C1 BDB1 3763 8608 4E20 C7EB 4578 740A EEA2' > /etc/apt/trusted.gpg.d/sapmachine.old.gpg.asc \
    && wget -q -O - https://dist.sapmachine.io/debian/sapmachine.key | gpg --batch --import \
    && gpg --batch --export --armor 'CACB 9FE0 9150 307D 1D22 D829 6275 4C3B 3ABC FE23' > /etc/apt/trusted.gpg.d/sapmachine.gpg.asc \
    && gpgconf --kill all && rm -rf "$GNUPGHOME" \
    && echo "deb http://dist.sapmachine.io/debian/amd64/ ./" > /etc/apt/sources.list.d/sapmachine.list \
    && apt-get update \
    && apt-get -y --no-install-recommends install sapmachine-11-jdk

RUN rm -rf /opt/java/openjdk
RUN cp -rf /usr/lib/jvm/sapmachine-11 /opt/java/openjdk

RUN pip3 install requests

USER jenkins
RUN git clone https://github.com/sap/SapMachine-infrastructure /tmp/SapMachine-infrastructure
RUN python3 /tmp/SapMachine-infrastructure/lib/jenkins_restore.py -s /tmp/SapMachine-infrastructure -t /var/jenkins_home --install-plugins
RUN rm -rf /tmp/SapMachine-infrastructure

COPY init-sapmachine.groovy /usr/share/jenkins/ref/init.groovy.d/init-sapmachine.groovy
COPY read-sapmachine-pw.sh /usr/share/jenkins/read-sapmachine-pw.sh
COPY read-client-secret.sh /usr/share/jenkins/read-client-secret.sh


USER root
RUN mkdir /var/clients
RUN mkdir /var/log/jenkins

RUN mkdir -p /var/pkg/deb/amd64
RUN mkdir -p /var/pkg/deb/keys
RUN mkdir -p /var/pkg/apk/3.5/x86_64
RUN mkdir -p /var/pkg/apk/keys
RUN mkdir -p /var/docs/api/10
RUN mkdir -p /var/docs/api/11
RUN mkdir -p /var/docs/api/12

COPY keys/debian/* /var/pkg/deb/keys/
COPY keys/alpine/* /var/pkg/apk/keys/
COPY credentials.yml /var/clients/credentials.yml
COPY log.properties /var/jenkins_home/log.properties

RUN chown -R jenkins:jenkins /var/log/jenkins
RUN chown -R jenkins:jenkins /var/pkg
RUN chown -R jenkins:jenkins /var/clients
RUN chown jenkins:jenkins /usr/share/jenkins/ref/init.groovy.d/*.groovy
RUN chown jenkins:jenkins /var/clients/credentials.yml
RUN chown jenkins:jenkins /usr/share/jenkins/read-sapmachine-pw.sh
RUN chown jenkins:jenkins /usr/share/jenkins/read-client-secret.sh
RUN chown jenkins:jenkins /var/jenkins_home/log.properties
RUN chmod +x /usr/share/jenkins/read-sapmachine-pw.sh
RUN chmod +x /usr/share/jenkins/read-client-secret.sh


USER jenkins
ENV JAVA_OPTS="-Djenkins.install.runSetupWizard=false -Djava.util.logging.config.file=/var/jenkins_home/log.properties -Dorg.jenkinsci.plugins.durabletask.BourneShellScript.HEARTBEAT_CHECK_INTERVAL=6000 -Dorg.jenkinsci.plugins.docker.workflow.client.DockerClient.CLIENT_TIMEOUT=6000 -Dhudson.slaves.ChannelPinger.pingIntervalSeconds=120 -Dhudson.slaves.ChannelPinger.pingTimeoutSeconds=600"
# ENV JAVA_ARGS="-Xms10g"
VOLUME /var/pkg
VOLUME /var/clients
VOLUME /var/log/jenkins
WORKDIR /var/jenkins_home
