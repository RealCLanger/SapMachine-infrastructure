pipeline {
    agent {
        label params.AGENT_LABEL
    }
    stages {
        stage('Generate Dockerfile') {
            steps {
                script {
                    def major_version = (params.GIT_TAG_NAME =~ /[^-]*-([0-9]+)[\.0-9]*\+.*/)[0][1]
                    def workdir = 'dockerfiles/official/' + major_version

                     //git([url: 'https://github.com/SAP/SapMachine-infrastructure.git', branch: 'master', credentialsId: 'SapMachine-github', changelog: false, poll: false])

                    sh(
                        script: "python lib/make_docker_image.py -t ${GIT_TAG_NAME} -i jdk --workdir ${workdir}",
                        returnStdout: false
                    )

                    sh(
                        script: "git add dockerfiles",
                        returnStdout: false
                    )

                    sh(
                        script: "git commit -m 'Updated official Docker files.'",
                        returnStdout: false
                    )

                    sh(
                        script: "git push",
                        returnStdout: false
                    )
                }
            }
        }
    }
    post {
        always {
            cleanWs deleteDirs: true, disableDeferredWipeout: true
        }
    }
}
