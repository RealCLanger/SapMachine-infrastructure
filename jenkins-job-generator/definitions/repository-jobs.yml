- job:
    name: repository-update-and-tag
    description: 'Update SapMachine repository from OpenJDK, tag and build SapMachine releases and create OpenJDK merge PRs.'
    project-type: pipeline
    sandbox: true
    concurrent: false
    properties:
        - build-discarder:
            num-to-keep: 60
    parameters:
        - bool:
            name: UPDATE_REPOSITORY
            default: true
            description: 'Update SapMachine repository from OpenJDK.'
        - bool:
            name: TAG_BUILD_AND_MERGE
            default: true
            description: 'Tag new SapMachine releases, build them and create OpenJDK merge PRs.'
    triggers:
        - timed: "@midnight"
    dsl: |
        pipeline {{
            agent {{
                label 'infrastructure'
            }}
            stages {{
                stage("Checkout Infrastructure Repository") {{
                    steps {{
                        sh '''#!/bin/bash
                            set -ex
                            if [ ! -d SapMachine-infrastructure ]; then
                              git init SapMachine-infrastructure
                            fi
                            cd SapMachine-infrastructure
                            git fetch --depth 1 https://github.com/SAP/SapMachine-infrastructure.git master
                            git checkout --detach FETCH_HEAD
                        '''
                    }}
                }}
                stage('Update SapMachine Repository') {{
                    when {{
                        expression {{ params.UPDATE_REPOSITORY == true }}
                    }}
                    steps {{
                        withCredentials([usernamePassword(credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD')]) {{
                            sh '''
                                openjdk_repositories=$(python3 SapMachine-infrastructure/lib/list_openjdk_repositories.py)
                                for i in ${{openjdk_repositories}}
                                do
                                    :
                                    SapMachine-infrastructure/lib/update_repo.sh $i
                                done
                            '''
                        }}
                    }}
                }}
                stage("Checkout SapMachine Repository") {{
                    when {{
                        expression {{ params.TAG_BUILD_AND_MERGE == true }}
                    }}
                    steps {{
                        sh '''#!/bin/bash
                            set -ex
                            if [ ! -d SapMachine ]; then
                              git init SapMachine && cd SapMachine
                              git remote add origin https://github.com/SAP/SapMachine.git
                            else
                              cd SapMachine
                            fi
                            git fetch origin
                            git remote prune origin
                            git checkout sapmachine
                        '''
                    }}
                }}
                stage('Tag, Build and Merge') {{
                    agent {{
                        docker {{
                            image 'infrastructure-x86_64'
                            reuseNode true
                            label 'infrastructure'
                        }}
                    }}
                    when {{
                        beforeAgent true
                        expression {{ params.TAG_BUILD_AND_MERGE == true }}
                    }}
                    steps {{
                        withCredentials([usernamePassword(credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD')]) {{
                            sh("cd SapMachine && python3 ../SapMachine-infrastructure/lib/tag_build_and_merge.py")
                        }}
                    }}
                }}
            }}
        }}
