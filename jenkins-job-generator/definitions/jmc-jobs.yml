- defaults:
    name: 'jmc_global'
    publish_default: false
    release_default: false
    allow_concurrent_builds: false
    trigger: |
        <org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
            <triggers/>
        </org.jenkinsci.plugins.workflow.job.properties.PipelineTriggersJobProperty>
    majors: &majors
        - 'official':
           branch_name: master
        - 'sap':
           branch_name: sap
    platforms: &platforms
        - linux_x86_64:
            docker_agent: |
                agent {{
                    dockerfile {{
                        dir "SapMachine-Infrastructure/dockerfiles/jmc/x86_64"
                        reuseNode true
                        label "{platform}"
                    }}
                }}
        - macos_x86_64:
            docker_agent: ''
        - macos_aarch64:
            docker_agent: ''
        - windows_x86_64:
            docker_agent: ''
    build_types: &build_types
        - snapshot
        - release

- project:
    name: jmc_builds
    major: *majors
    build_type: *build_types
    platform: *platforms
    jobs:
        - build-jmc-{major}-{build_type}-{platform}

- job-template:
    name: build-jmc-{major}-{build_type}-{platform}
    defaults: 'jmc_global'
    description: 'This project is generated. Do not modify manually.'
    project-type: pipeline
    concurrent: '{allow_concurrent_builds}'
    properties:
        - github:
            url: 'https://github.com/SAP/jmc'
        - build-discarder:
            num-to-keep: 100
            artifact-num-to-keep: 1
        - raw:
            xml: '{trigger}'
    parameters:
        - string:
            name: JMC_GIT_REPOSITORY
            default: 'https://github.com/SAP/jmc'
            description: 'The Git repository to use.'
        - string:
            name: JMC_GIT_BRANCH
            default: '{branch_name}'
            description: 'The Git branch to build.'
        - string:
            name: GIT_TAG_NAME
            default: ''
            description: 'The Git tag to build.'
        - string:
            name: BUILD_JDK
            default: '11'
            description: 'The JDK used to build the JMC'
        - string:
            name: JMC_ARCHIVE_NAME_PREFIX
            default: 'jmc-{major}-{platform}'
            description: 'The prefix of the bundle archive.'
        - bool:
            name: RELEASE
            default: '{release_default}'
            description: 'When set to true, marks this build as a release build, otherwise as pre-release.'

    dsl: |
        pipeline {{
            agent {{
                label "{platform}"
            }}
            stages {{
                stage("Init") {{
                    steps {{
                        cleanWs deleteDirs: true, disableDeferredWipeout: true
                        checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: '*/master']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'SapMachine-Infrastructure']], userRemoteConfigs: [[credentialsId: 'SapMachine-github', url: 'https://github.com/SAP/SapMachine-infrastructure.git']]]
                    }}
                }}
                stage("Checkout Repository") {{
                    steps {{
                        checkout changelog: true, poll: false, scm: [$class: 'GitSCM', branches: [[name: "*/${{params.JMC_GIT_BRANCH}}"]], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'jmc']], userRemoteConfigs: [[credentialsId: 'SapMachine-github', url: "${{params.JMC_GIT_REPOSITORY}}"]]]
                    }}
                }}
                stage ('Download Prerequisites'){{
                    when {{
                         expression {{ !(JOB_NAME ==~ /((\S*)(macos_aarch64)(\S*))/) && !(JOB_NAME ==~ /((\S*)(windows_x86_64)(\S*))/) }}
                    }}
                    steps {{
                        ccache -C -zwithCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD']]) {{
                            sh "python3 SapMachine-Infrastructure/lib/download_boot_jdk.py -m ${{params.BUILD_JDK}} -d ${{WORKSPACE}}"
                        }}
                    }}
                }}
                stage ('Download Prerequisites Windows'){{
                    when {{
                         expression {{ JOB_NAME ==~ /((\S*)(windows_x86_64)(\S*))/ }}
                    }}
                    steps {{
                        sh 'SapMachine-Infrastructure/lib/install-deps-jmc-win.sh'
                    }}
                }}
                stage ('Download Prerequisites Mac OS aarch64'){{
                    when {{
                         expression {{ JOB_NAME ==~ /((\S*)(macos_aarch64)(\S*))/ }}
                    }}
                    steps {{
                        sh 'SapMachine-Infrastructure/lib/install-deps-jmc-macos-aarch64.sh'
                    }}
                }}
                stage("Build and Basic Tests") {{
                    {docker_agent}
                    when {{
                        expression {{ !(JOB_NAME ==~ /((\S*)(windows_x86_64)(\S*))/) }}
                    }}
                    environment {{
                        BUILD_JDK = "${{WORKSPACE}}/boot_jdk"
                        JAVA_HOME = "${{WORKSPACE}}/boot_jdk"
                    }}
                    steps {{
                        sh 'ls ${{WORKSPACE}}/boot_jdk'
                        sh 'SapMachine-Infrastructure/lib/build_jmc.sh'
                    }}
                }}
                stage("Build and Basic Tests Windows") {{
                    when {{
                         expression {{ JOB_NAME ==~ /((\S*)(windows_x86_64)(\S*))/ }}
                    }}
                    steps {{
                        sh 'SapMachine-Infrastructure/lib/build_jmc_win.sh'
                    }}
                }}
                stage("Test") {{
                    {docker_agent}
                    when {{
                        expression {{ !(JOB_NAME ==~ /((\S*)(windows_x86_64)(\S*))/) && false }}
                    }}
                    environment {{
                        BUILD_JDK = "${{WORKSPACE}}/boot_jdk"
                    }}
                    steps {{
                        sh 'SapMachine-Infrastructure/lib/test_jmc.sh'
                    }}
                }}
                stage('Archive') {{
                    steps {{
                        script {{
                            def artifact_name = readFile "${{env.WORKSPACE}}/jmc/artifact.txt"
                            step ([$class: 'ArtifactArchiver', artifacts: artifact_name]);
                        }}
                    }}
                }}
                stage('Publish GitHub') {{
                    when {{
                        expression {{ params.RELEASE == true && JOB_NAME ==~ /((\S*)(release)(\S*))/ }}
                    }}
                    steps {{
                        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD']]) {{
                            sh '''
                            SapMachine-Infrastructure/lib/publish_jmc.sh
                            '''
                        }}
                    }}
                }}
            }}
        }}

- job:
    name: jmc-repository-update-and-tag
    description: 'Update JMC repository from OpenJDK, tag and build JMC releases and create JMC merge PRs.'
    project-type: pipeline
    concurrent: false
    properties:
        - build-discarder:
            num-to-keep: 60
    parameters:
        - bool:
            name: UPDATE_REPOSITORY
            default: true
            description: 'Update JMC repository from OpenJDK.'
        - bool:
            name: TAG_BUILD_AND_MERGE
            default: true
            description: 'Tag new JMC releases, build them and create JMC merge PRs.'
    triggers:
        - timed: "@midnight"
    dsl: |
        pipeline {
            agent {
                label "repository"
            }
            stages {
                stage("Checkout Infrastructure Repository") {
                    steps {
                        checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: '*/master']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'SapMachine-Infrastructure']], userRemoteConfigs: [[url: 'https://github.com/SAP/SapMachine-infrastructure.git']]]
                    }
                }
                stage('Update SapMachine JMC Repository') {
                    agent {
                        dockerfile {
                            dir "SapMachine-Infrastructure/dockerfiles/infrastructure"
                            reuseNode true
                            label "repository"
                        }
                    }
                    when {
                        beforeAgent true
                        expression { params.UPDATE_REPOSITORY == true }
                    }
                    steps {
                        withCredentials([usernamePassword(credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD')]) {
                            sh("SapMachine-Infrastructure/lib/jmc/update_repo.sh")
                        }
                    }
                }
                stage("Checkout SapMachine JMC Repository") {
                    when {
                        expression { params.TAG_BUILD_AND_MERGE == true }
                    }
                    steps {
                        checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: "*/sap"]], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'sapjmc']], userRemoteConfigs: [[url: 'https://github.com/SAP/jmc.git"']]]
                    }
                }
            }
        }

- job:
    name: jmc-repo-update
    description: 'Update JMC repository.'
    project-type: pipeline
    concurrent: false
    properties:
        - build-discarder:
            num-to-keep: 60
    dsl: |
        pipeline {
            agent {
                label "repository"
            }
            stages {
                stage("Checkout Infrastructure Repository") {
                    steps {
                        checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: '*/master']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'SapMachine-Infrastructure']], userRemoteConfigs: [[url: 'https://github.com/SAP/SapMachine-infrastructure.git']]]
                    }
                }
                stage("Checkout Repository") {
                    steps {
                        checkout changelog: true, poll: false, scm: [$class: 'GitSCM', branches: [[name: '*/sap']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'jmc']], userRemoteConfigs: [[url: 'https://github.com/SAP/jmc.git']]]
                    }
                }
                stage('Merge') {
                    agent {
                        dockerfile {
                            dir "SapMachine-Infrastructure/dockerfiles/infrastructure"
                            reuseNode true
                            label "repository"
                        }
                    }
                    steps {
                        withCredentials([usernamePassword(credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD')]) {
                            script {
                                env.JMC_BUILD_REQUIRED = sh(
                                        script: "SapMachine-Infrastructure/lib/merge_jmc.sh",
                                        returnStatus: true
                                )
                            }
                        }
                    }
                }
                stage ('Trigger Snapshot Builds') {
                    when {
                        expression { env.JMC_BUILD_REQUIRED != "1" }
                    }
                    steps {
                        parallel (
                            linux_x86_64: {
                                build job: 'build-jmc-official-snapshot-linux_x86_64', parameters: [string(name: 'JMC_GIT_BRANCH', value: 'sap')]
                            },
                            macos_x86_64: {
                                build job: 'build-jmc-official-snapshot-macos_x86_64', parameters: [string(name: 'JMC_GIT_BRANCH', value: 'sap')]
                            },
                            macos_aarch64: {
                                build job: 'build-jmc-official-snapshot-macos_aarch64', parameters: [string(name: 'JMC_GIT_BRANCH', value: 'sap')]
                            },
                            failFast: false
                        )
                    }
                }
            }
        }

- job:
    name: jmc-release-build
    description: 'Build JMC release.'
    project-type: pipeline
    concurrent: false
    properties:
        - build-discarder:
            num-to-keep: 60
    parameters:
        - string:
            name: VERSION
            description: 'Version of this release'
    dsl: |
        pipeline {
            agent {
                label "repository"
            }
            stages {
                stage("Checkout Infrastructure Repository") {
                    steps {
                        checkout changelog: false, poll: false, scm: [$class: 'GitSCM', branches: [[name: '*/master']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'SapMachine-Infrastructure']], userRemoteConfigs: [[url: 'https://github.com/SAP/SapMachine-infrastructure.git']]]
                    }
                }
                stage("Checkout Repository") {
                    steps {
                        checkout changelog: true, poll: false, scm: [$class: 'GitSCM', branches: [[name: '*/sap']], extensions: [[$class: 'RelativeTargetDirectory', relativeTargetDir: 'jmc']], userRemoteConfigs: [[url: 'https://github.com/SAP/jmc.git']]]
                    }
                }
                stage('Merge') {
                    agent {
                        dockerfile {
                            dir "SapMachine-Infrastructure/dockerfiles/infrastructure"
                            reuseNode true
                            label "repository"
                        }
                    }
                    steps {
                        withCredentials([usernamePassword(credentialsId: 'SapMachine-github', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_PASSWORD')]) {
                            script {
                                env.JMC_BUILD_REQUIRED = sh(
                                        script: "SapMachine-Infrastructure/lib/merge_jmc.sh",
                                        returnStatus: true
                                )
                            }
                        }
                    }
                }
                stage ('Trigger Release Builds') {
                    when {
                        expression { env.ASYNC_PROF_RELEASE_TAG != "No new releases" }
                    }
                    steps {
                        parallel (
                            linux_x86_64: {
                                build job: 'build-jmc-official-release-linux_x86_64', parameters: [string(name: 'JMC_GIT_BRANCH', value: 'sap'), string(name: 'GIT_TAG_NAME', value: params.VERSION), [$class: 'BooleanParameterValue', name: 'RELEASE', value: 'true']]
                            },
                            macos_x86_64: {
                                build job: 'build-jmc-official-release-macos_x86_64', parameters: [string(name: 'JMC_GIT_BRANCH', value: 'sap'), string(name: 'GIT_TAG_NAME', value: params.VERSION), [$class: 'BooleanParameterValue', name: 'RELEASE', value: 'true']]
                            },
                            macos_aarch64: {
                                build job: 'build-jmc-official-release-macos_aarch64', parameters: [string(name: 'JMC_GIT_BRANCH', value: 'sap'), string(name: 'GIT_TAG_NAME', value: params.VERSION), [$class: 'BooleanParameterValue', name: 'RELEASE', value: 'true']]
                            },
                            failFast: false
                        )
                    }
                }
            }
        }
